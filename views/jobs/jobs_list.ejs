<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos</title>
    <script src="https://kit.fontawesome.com/2f7352ec62.js" crossorigin="anonymous"></script>
    <script src="/public/scripts/http_helper.js"></script>
    <script src="/public/scripts/get_user.js"></script>
    <script src="/public/scripts/notifications.js" defer></script>
    <script src="/public/scripts/inputs.js" defer></script>
    <script src="/public/scripts/tab_switch.js" defer></script>

    <link rel="stylesheet" href="/public/styles/main.css">
    <link rel="stylesheet" href="/public/styles/side_tab.css">
    <link rel="stylesheet" href="/public/styles/buttons.css">
    <link rel="stylesheet" href="/public/styles/structure_cards.css">
    <link rel="stylesheet" href="/public/styles/grid_table.css">
    <link rel="stylesheet" href="/public/styles/info_card.css">
    <link rel="stylesheet" href="/public/styles/inputs.css">
    <link rel="stylesheet" href="/public/styles/select.css">

    <style>

    </style>
</head>
<body>
    <div class="notification" id="notification">
        <div>
            <i class="fa-solid fa-check"></i>
            <div>
                <p></p>
            </div>
        </div>
    </div>
    <div class="hover-container">        
        <div class="ifc-loading" id="loading_spinner">
            <div class="lds-dual-ring"></div>
            <label for="">Aguarde...</label>
        </div>
        <!-- <div class="info-card w35" id="link_product">
            <div class="ifc-header">
                <h3>Vincular Produto</h3>
                <i class="fa-solid fa-xmark" onclick="toggleHoverContainer()"></i>
            </div>
            <div class="ifc-body">
                <div class="inpt">
                    <input placeholder="Insira sku do produto" id="code_input" type="text">
                </div>
                    <div class="tb-container">
                        <table class="tb-table" id="items_table">
                            <thead>
                                <tr>
                                    <th width="1"><i class="fa-solid fa-location-arrow"></i></th>
                                    <th>Impressora</th>
                                    <th>Filamento</th>
                                    <th>Material</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="checkbox" name="" id=""></td>
                                    <td>Creality</td>
                                    <td>Voolt</td>
                                    <td>ABS</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
            </div>
            <div class="ifc-footer">
                <button class="btn primary">Salvar</button>
            </div>
        </div> -->
    </div>
    <div class="main-container">
        <div class="side-nav close" id="side_nav">
            <div class="option close switch" href="">
                <i class="fa-solid fa-bars"></i>
                <span>3D System</span>
            </div>
            <a class="option close" href="/jobs" id="jobs">
                <i class="fa-solid fa-layer-group"></i>
                <span>Pedidos</span>
            </a>
            <a class="option close" href="">
                <i class="fa-solid fa-box-open"></i>
                <span>Separação</span>
            </a>
            <a class="option close" href="">
                <i class="fa-solid fa-kaaba"></i>
                <span>Impressoras</span>
            </a>
            <a class="option close" href="">
                <i class="fa-solid fa-wrench"></i>
                <span>Manutenção</span>
            </a>
            <a class="option close" href="/users" id="users">
                <i class="fa-solid fa-users"></i>
                <span>Usuários</span>
            </a>
            <a class="option close" href="/config" id="config">
                <i class="fa-solid fa-gear"></i>
                <span>Configurações</span>
            </a>
        </div>
        <div class="container">
            <div class="content flex col" id="title">
                <div class="struct-card row align-center space-between">
                    <div class="flex align-center gap-1">
                        <i class="fa-solid fa-user ct-user"></i>    
                        <h3 id="user_name"></h3>
                    </div>
                    <div>
                        <button class="btn basic">Sair</button>
                    </div>
                </div>
                <div class="struct-card row">
                    <button class="btn primary" onclick="fetchItems()">Buscar</button>
                </div>
                <div class="struct-card row align-center space-between" id="ti_1">
                    <div class="flex">
                        <button class="btn primary">Separar</button>
                        <div class="spacer vertical"></div>
                        <div class="flex align-center">
                            <button class="btn primary">Enviar Fila</button>
                            <select class="select" name="" id="printers_select"></select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="content flex align-start" id="ct_1">
                <div class="struct-card over_h">
                    <div class="tb-container">
                        <table class="tb-table" id="items_table">
                            <!-- <thead>
                                <tr>
                                    <th width="1"><i class="fa-solid fa-location-arrow"></i></th>
                                    <th>Pedido</th>
                                    <th>Aton SKU</th>
                                    <th>Produto</th>
                                    <th>Ecommerce</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="checkbox" name="" id=""></td>
                                    <td class="flex align-center">91256</td>
                                    <td>TD0001</td>
                                    <td>TD0001</td>
                                    <td>SHEIN DELIQUADROS</td>
                                </tr>
                            </tbody> -->
                        </table>
                    </div>
                </div>
                <div class="struct-card w35" id="printer_info_holder">
                    <!-- <span class="lb-title">
                        <i class="fa-solid fa-kaaba"></i>
                        <span>#1 - K1 Max - Cima</span>
                    </span>
                    <p class="flex space-between"><b>Filamento:</b> Voolt - PLA - Preto</p>
                    <p class="flex space-between"><b>Quantidade:</b> 500g / 800g</p>
                    <p class="flex space-between"><b>Quantidade Selecionada:</b> 650g</p> -->
                </div>
            </div>

        </div>
    </div>
    <script>
    function setUser(){
        const user = JSON.parse(localStorage.getItem("user"));
        const user_name = document.querySelector("#user_name");

        user_name.innerHTML = user.firstName;
        const viewportWidth = window.innerWidth;
        
        if(viewportWidth < 600){
            user_name.style.fontSize = "1rem";
        }
    }
    setUser();

    function updateScreenSize() {
        const viewportWidth = window.innerWidth;
        const ct_1 = document.querySelector("#ct_1");
        const ti_1 = document.querySelector("#ti_1");

        const card2 = ct_1.querySelector(".struct-card:nth-child(2)");
        const ti_1_div2 = ti_1.querySelector("div:nth-child(1)");
        const ti_1_div2_div2 = ti_1.querySelector("div:nth-child(1) > div:nth-child(3)");
        const ti_1_sp = ti_1.querySelector(".spacer");

        const isMobile = viewportWidth < 600;

        ct_1.classList.toggle("wrap", isMobile);
        ct_1.classList.toggle("col-rev", isMobile);
        card2.classList.toggle("w35", !isMobile);

        ti_1.classList.toggle("wrap", isMobile);
        ti_1_div2.classList.toggle("wrap", isMobile);
        ti_1_sp.classList.toggle("horizontal", isMobile);
        ti_1_sp.classList.toggle("vertical", !isMobile);
        ti_1_div2_div2.classList.toggle("wrap", isMobile);
    }

    updateScreenSize();
    window.addEventListener('resize', updateScreenSize);

    




    const hover_elements = 
    {
        loading_spinner: document.querySelector("#loading_spinner"),
    }

    const hover_container = document.querySelector(".hover-container");
    hover_container.style.display = "none";

    function toggleHoverContainer(el_id){
        if(hover_container.style.display == "none"){
            hover_container.style.display = "flex";

            for (const [key, value] of Object.entries(hover_elements)) {
            
                if(key == el_id){
                    value.style.display = "flex";
                    continue;
                }

                value.style.display = "none";
            }
            
        }else{
            hover_container.style.display = "none";
        }
    }

    
    const printers_select = document.querySelector("#printers_select");
    const printer_info_holder = document.querySelector("#printer_info_holder");

    async function main(params) {
        let printers = await fetchInfo("/api/v1/printers");
        printers = printers.data;

        let prt_sel_html = "";

        for (const printer of printers) {
            prt_sel_html += `<option value="${printer.id}">#${printer.id} - ${printer.label}</option>`;
        }

        printers_select.innerHTML = prt_sel_html;

        getPrinterInfo();
    }

    main();

    async function getPrinterInfo(){
        let current_filament = await fetchInfo(`/api/v1/printers/filaments/current?printer_id=${printers_select.value}`);
        current_filament = current_filament.data;

        console.log(current_filament)

        printer_info_holder.innerHTML = 
        `
        <span class="lb-title">
            <i class="fa-solid fa-kaaba"></i>
            <span>#1 - K1 Max - Cima</span>
        </span>
        <p class="flex space-between"><b>Filamento:</b> ${current_filament[0].filament.filament_brands_name} - ${current_filament[0].filament.material_name} - ${current_filament[0].filament.color}</p>
        <p class="flex space-between"><b>Quantidade:</b> ${current_filament[0].current_quantity}g / ${current_filament[0].entry_quantity}g</p>
        `;
    }

    printers_select.addEventListener('change', getPrinterInfo);

    const items_table = document.querySelector("#items_table");

    async function fetchItems() {
        toggleHoverContainer("loading_spinner");

        let items = await fetchInfo("/api/v1/jobs/fetch");
        items = items.data;

        let table_html =
        `
        <thead>
            <tr>
                <th width="1"><i class="fa-solid fa-location-arrow"></i></th>
                <th>Pedido</th>
                <th>Aton SKU</th>
                <th>Ecommerce</th>
            </tr>
        </thead>
        <tbody>
        `;

        for (const item of items) {
            table_html +=
            `
                <tr>
                    <td><input type="checkbox"></td>
                    <td>${item.order_id}</td>
                    <td>${item.aton_sku}</td>
                    <td>${item.ecommerce}</td>
                </tr>
            `;
        }

        table_html += "</tbody>";

        items_table.innerHTML = table_html;

        toggleHoverContainer();
    }


    </script>
</body>
</html>